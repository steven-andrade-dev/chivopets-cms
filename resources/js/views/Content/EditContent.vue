<script setup lang="ts">
import Navbar from "../../components/Navbar.vue";
import Sidebar from "../../components/Sidebar.vue";
import { useRoute, useRouter } from "vue-router";
import { httpRequest } from "../../utils/global-request";
import { onMounted, ref } from "vue";
import { QuillEditor } from "@vueup/vue-quill";
import Quill from "quill";
import "@vueup/vue-quill/dist/vue-quill.snow.css";

const contenidoHtml = ref('');
const route = useRoute();
const router = useRouter();
const id = route.params.id;
const content = ref([]);

const SizeStyle = Quill.import("attributors/style/size");
SizeStyle.whitelist = [
    "12px",
    "14px",
    "16px",
    "18px",
    "24px",
    "32px",
    "48px",
    "53px",
];
Quill.register(SizeStyle, true);

const globalOptions = {
    debug: "",
    modules: {
        toolbar: "#custom-toolbar",
        // Otros módulos disponibles:
        history: {
            delay: 2000,
            maxStack: 500,
            userOnly: true,
        },
        clipboard: {
            matchVisual: false,
        },
        keyboard: {
            bindings: {},
        },

        syntax: true, // true para resaltar código (necesita highlight.js)
    },
    formats: [
        "size",
        "color",
        "bold",
        "italic",
        "underline",
        "strike",
        "blockquote",
        "code-block",
        "list",
        "bullet",
        "link",
        "image",
        "video",
    ],
    theme: "snow",
};
// set default globalOptions prop
QuillEditor.props.globalOptions.default = () => globalOptions;

const getContentById = async () => {
    try {
        const response = await httpRequest({
            url: `/content-by-id/${id}`,
            method: "GET",
        });
        content.value = response.data;
        contenidoHtml.value = response.data.bloque_principal;
        console.log(response);
        console.log(content.value);
    } catch (err) {
        console.error(err);
    }
};

const guardarContent = async () => {
    const data = {
        id: id,
        title: content.value.name,
        bloque_principal: contenidoHtml.value,
        bloque_secundario: content.value.bloque_secundario,
        url: content.value.url,
    }
   try {
    const response = await httpRequest({
        url: '/contenido/update',
        method: 'PUT',
        data: data
    });
    if(response.success){
       alert(response.msg);
    }else{
        alert(response.msg);
    }
   }catch(err){
    console.error(err);
   }
}

const regresar = () => {
    router.go(-1);
}

onMounted(() => {
    getContentById();
});
</script>

<template>
    <div id="wrapper">
        <Sidebar />
        <div id="content-wrapper" class="d-flex flex-column">
            <div id="content">
                <Navbar />
                <div class="container-fluid">
                    <div class="container">
                        <div class="card m-3">
                            <div class="card-header">
                                <div class="card-title">
                                    <div class="status-dot"></div>
                                    Editor de Contenido
                                </div>
                            </div>

                            <div class="card-content">
                                <form id="hospitalForm">
                                    <!-- Información Básica -->
                                    <div class="section">
                                        <div class="section-header">
                                            <span class="badge">Básico</span>
                                            <h3 class="section-title">
                                                Información Principal
                                            </h3>
                                        </div>

                                        <div class="form-group">
                                            <label for="name">Título Principal</label>
                                            <input type="text" id="name" placeholder="Titulo" v-model="content.name" />
                                        </div>

                                        <div class="form-group">
                                            <label for="description">Descripción</label>
                                            <div id="custom-toolbar">
                                                <select class="ql-size">
                                                    <option value="12px">
                                                        12 px
                                                    </option>
                                                    <option value="14px">
                                                        14 px
                                                    </option>
                                                    <option value="16px">
                                                        16 px
                                                    </option>
                                                    <option value="18px">
                                                        18 px
                                                    </option>
                                                    <option value="24px">
                                                        24 px
                                                    </option>
                                                    <option value="32px">
                                                        32 px
                                                    </option>
                                                    <option value="48px">
                                                        48 px
                                                    </option>
                                                    <option value="53px">
                                                        53 px
                                                    </option>
                                                </select>
                                                <button class="ql-bold"></button>
                                                <button class="ql-italic"></button>
                                                <button class="ql-underline"></button>
                                                <select class="ql-color"></select>
                                                <button class="ql-list" value="ordered"></button>
                                                <button class="ql-list" value="bullet"></button>
                                                <button class="ql-link"></button>
                                                <button class="ql-clean"></button>
                                            </div>
                                            <quill-editor ref="editorRef" 
                                            theme="snow" 
                                            toolbar="#custom-toolbar"
                                            contentType="html"
                                            :global-options="globalOptions" 
                                            v-model:content="contenidoHtml" />
                                            <div class="help-text">
                                                El HTML se generará
                                                automáticamente
                                            </div>
                                            <div style="margin-top:20px;">
                                            <strong>Vista previa HTML:</strong>
                                            <div v-html="contenidoHtml" style="border:1px solid #eee;padding:12px;"></div>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label for="url">Texto del Botón</label>
                                            <input type="text" id="url" placeholder="Texto del botón de acción"
                                            v-model="content.url" />
                                        </div>
                                    </div>

                                    <div class="separator"></div>

                                    <!-- Configuración Técnica -->
                                    <div class="section">
                                        <div class="section-header">
                                            <span class="badge secondary">Técnico</span>
                                            <h3 class="section-title">
                                                Configuración
                                            </h3>
                                        </div>



                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="image">URL de Imagen</label>
                                                <input type="url" id="image"
                                                    placeholder="https://ejemplo.com/imagen.jpg"
                                                    v-model="content.image" />
                                            </div>
                                            <div class="form-group">
                                                <label for="locale">Idioma</label>
                                                <input type="text" id="locale" placeholder="es, en, etc."
                                                    v-model="content.locale" />
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label for="type_carrusel">Tipo de Carrusel</label>
                                            <input type="text" id="type_carrusel"
                                                placeholder="Tipo de carrusel (opcional)"
                                                v-model="content.type_carrusel" />
                                        </div>
                                    </div>

                                    <div class="actions">
                                        <button type="button" class="btn btn-secondary" @click="regresar">
                                            ← Regresar
                                        </button>
                                        <button type="button" class="btn btn-success" @click="guardarContent">
                                            💾 Guardar
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Copyright &copy; Chivo Pets</span>
                    </div>
                </div>
            </footer>
        </div>
    </div>
</template>

<style>
.container {
    max-width: 800px;
    margin: 0 auto;
}

.header {
    text-align: center;
    margin-bottom: 40px;
}

.header h1 {
    color: #1f2937;
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 8px;
}

.header p {
    color: #6b7280;
    font-size: 1rem;
}

.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.card-header {
    background: #f8fafc;
    border-bottom: 1px solid #e5e7eb;
    padding: 20px;
}

.card-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #10b981;
}

.card-content {
    padding: 30px;
}

.section {
    margin-bottom: 32px;
}

.section:last-child {
    margin-bottom: 0;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 20px;
}

.badge {
    background: #f3f4f6;
    color: #374151;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
    border: 1px solid #d1d5db;
}

.badge.secondary {
    background: #e5e7eb;
    color: #4b5563;
}

.section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2937;
}

.form-group {
    margin-bottom: 20px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.form-row.single {
    grid-template-columns: 1fr;
}

label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 6px;
}

input,
textarea {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    background: white;
}

input:focus,
textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

textarea {
    min-height: 100px;
    resize: vertical;
    font-family: inherit;
}

.help-text {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 4px;
}

.separator {
    height: 1px;
    background: #e5e7eb;
    margin: 24px 0;
}

.actions {
    display: flex;
    gap: 12px;
    margin-top: 32px;
}

.btn {
    flex: 1;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
}

.btn-secondary {
    background: transparent;
    color: #374151;
    border: 1px solid #d1d5db;
}

.btn-secondary:hover {
    background: #f9fafb;
}

.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #10b981;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateX(100%);
    transition: transform 0.3s ease;
    z-index: 1000;
}

.toast.show {
    transform: translateX(0);
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }

    .actions {
        flex-direction: column;
    }

    .header h1 {
        font-size: 1.5rem;
    }
}
</style>
